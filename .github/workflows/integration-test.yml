name: Integration Test

on:
  # Cross-repository dispatch from service repos
  repository_dispatch:
    types: [integration-test]

  # Also support reusable workflow calls (backward compatibility)
  workflow_call:
    inputs:
      service_name:
        description: 'Service name to test (e.g., fm-case-service)'
        required: true
        type: string
      image_tag:
        description: 'Image tag to test (e.g., sha-abc123)'
        required: true
        type: string
      skip_deploy_verification:
        description: 'Skip ./faultmaven verify step (for testing workflow only)'
        required: false
        type: boolean
        default: false

jobs:
  integration-test:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Set input variables
        id: inputs
        run: |
          # Support both repository_dispatch and workflow_call
          if [ "${{ github.event_name }}" = "repository_dispatch" ]; then
            echo "service_name=${{ github.event.client_payload.service_name }}" >> $GITHUB_OUTPUT
            echo "image_tag=${{ github.event.client_payload.image_tag }}" >> $GITHUB_OUTPUT
            echo "triggered_by=${{ github.event.client_payload.triggered_by }}" >> $GITHUB_OUTPUT
            echo "pr_number=${{ github.event.client_payload.pr_number }}" >> $GITHUB_OUTPUT
            echo "run_id=${{ github.event.client_payload.run_id }}" >> $GITHUB_OUTPUT
          else
            echo "service_name=${{ inputs.service_name }}" >> $GITHUB_OUTPUT
            echo "image_tag=${{ inputs.image_tag }}" >> $GITHUB_OUTPUT
            echo "triggered_by=workflow_call" >> $GITHUB_OUTPUT
            echo "pr_number=" >> $GITHUB_OUTPUT
            echo "run_id=" >> $GITHUB_OUTPUT
          fi

      - name: Checkout faultmaven-deploy
        uses: actions/checkout@v4
        with:
          repository: FaultMaven/faultmaven-deploy
          ref: main

      - name: Log in to GHCR
        run: |
          echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin

      - name: Install yq
        run: |
          sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          sudo chmod +x /usr/local/bin/yq

      - name: Verify service exists in docker-compose.yml
        run: |
          SERVICE_NAME="${{ steps.inputs.outputs.service_name }}"
          if ! yq eval ".services | has(\"$SERVICE_NAME\")" docker-compose.yml | grep -q "true"; then
            echo "❌ Error: Service '$SERVICE_NAME' not found in docker-compose.yml"
            echo "Available services:"
            yq eval '.services | keys' docker-compose.yml
            exit 1
          fi
          echo "✅ Service '$SERVICE_NAME' found in docker-compose.yml"

      - name: Inject new image tag
        run: |
          SERVICE_NAME="${{ steps.inputs.outputs.service_name }}"
          IMAGE_TAG="${{ steps.inputs.outputs.image_tag }}"
          echo "Updating $SERVICE_NAME image to ghcr.io/faultmaven/$SERVICE_NAME:$IMAGE_TAG"
          yq -i ".services.$SERVICE_NAME.image = \"ghcr.io/faultmaven/$SERVICE_NAME:$IMAGE_TAG\"" docker-compose.yml

          # Verify the change
          echo "Updated image:"
          yq eval ".services.$SERVICE_NAME.image" docker-compose.yml

      - name: Create minimal .env file
        run: |
          cat > .env << 'EOF'
          # Minimal configuration for integration tests
          SERVER_HOST=localhost
          DASHBOARD_USERNAME=admin
          DASHBOARD_PASSWORD=changeme123

          # Placeholder API keys (tests don't require real keys)
          OPENAI_API_KEY=sk-test-placeholder
          ANTHROPIC_API_KEY=sk-ant-test-placeholder
          GROQ_API_KEY=gsk-test-placeholder
          EOF

      - name: Make faultmaven CLI executable
        run: chmod +x ./faultmaven

      - name: Start stack
        run: |
          echo "Starting FaultMaven stack with updated ${{ inputs.service_name }} image..."
          ./faultmaven start || {
            echo "❌ Failed to start stack"
            echo "Collecting logs..."
            ./faultmaven logs
            exit 1
          }

      - name: Wait for services to stabilize
        run: |
          echo "Waiting 30 seconds for services to stabilize..."
          sleep 30

      - name: Check service health
        run: |
          SERVICE_NAME="${{ steps.inputs.outputs.service_name }}"
          echo "Checking health of $SERVICE_NAME..."

          # Map service names to their external ports
          case "$SERVICE_NAME" in
            fm-auth-service)
              PORT=8001
              ;;
            fm-session-service)
              PORT=8002
              ;;
            fm-case-service)
              PORT=8003
              ;;
            fm-knowledge-service)
              PORT=8004
              ;;
            fm-evidence-service)
              PORT=8005
              ;;
            fm-agent-service)
              PORT=8006
              ;;
            fm-api-gateway)
              PORT=8090
              ;;
            *)
              echo "⚠️  No health check configured for $SERVICE_NAME"
              exit 0
              ;;
          esac

          # Try health check endpoint
          for i in {1..10}; do
            if curl -f -s http://localhost:${PORT}/health > /dev/null 2>&1; then
              echo "✅ Service $SERVICE_NAME is healthy (http://localhost:${PORT}/health)"
              exit 0
            fi
            echo "Attempt $i/10: Service not ready yet, waiting 5 seconds..."
            sleep 5
          done

          echo "❌ Service $SERVICE_NAME failed health check after 50 seconds"
          echo "Collecting logs for diagnosis..."
          docker logs $SERVICE_NAME || true
          exit 1

      - name: Run verification tests
        if: ${{ !inputs.skip_deploy_verification }}
        run: |
          echo "Running ./faultmaven verify..."
          ./faultmaven verify || {
            echo "❌ Verification tests failed"
            echo "Collecting logs..."
            ./faultmaven logs
            exit 1
          }

      - name: Integration test summary
        if: success()
        run: |
          SERVICE_NAME="${{ steps.inputs.outputs.service_name }}"
          IMAGE_TAG="${{ steps.inputs.outputs.image_tag }}"
          TRIGGERED_BY="${{ steps.inputs.outputs.triggered_by }}"

          echo "✅ Integration test passed for $SERVICE_NAME:$IMAGE_TAG"
          echo ""
          echo "Summary:"
          echo "- Service: $SERVICE_NAME"
          echo "- Image: ghcr.io/faultmaven/$SERVICE_NAME:$IMAGE_TAG"
          echo "- Triggered by: $TRIGGERED_BY"
          echo "- Stack started successfully"
          echo "- Health check passed"
          echo "- Verification tests passed"

      - name: Report status to triggering repo
        if: always() && github.event_name == 'repository_dispatch'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const status = '${{ job.status }}';
            const serviceName = '${{ steps.inputs.outputs.service_name }}';
            const imageTag = '${{ steps.inputs.outputs.image_tag }}';
            const triggeredBy = '${{ steps.inputs.outputs.triggered_by }}';
            const prNumber = '${{ steps.inputs.outputs.pr_number }}';
            const runId = '${{ steps.inputs.outputs.run_id }}';

            if (!triggeredBy || !runId) {
              console.log('No triggering repo info, skipping status report');
              return;
            }

            const [owner, repo] = triggeredBy.split('/');
            const conclusion = status === 'success' ? 'success' : 'failure';
            const runUrl = `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;

            const comment = `## Integration Test ${conclusion === 'success' ? '✅ Passed' : '❌ Failed'}

**Service**: \`${serviceName}\`
**Image**: \`ghcr.io/faultmaven/${serviceName}:${imageTag}\`
**Test Run**: [View logs](${runUrl})

${conclusion === 'success'
  ? 'The integration test passed. Your service works correctly with the full FaultMaven stack.'
  : 'The integration test failed. Please check the logs for details.'}`;

            if (prNumber) {
              // Post comment to PR
              await github.rest.issues.createComment({
                owner,
                repo,
                issue_number: parseInt(prNumber),
                body: comment
              });
            }

      - name: Collect logs on failure
        if: failure()
        run: |
          SERVICE_NAME="${{ steps.inputs.outputs.service_name }}"
          IMAGE_TAG="${{ steps.inputs.outputs.image_tag }}"

          echo "❌ Integration test failed for $SERVICE_NAME:$IMAGE_TAG"
          echo ""
          echo "Collecting all service logs..."
          ./faultmaven logs
          echo ""
          echo "Docker Compose status:"
          docker compose ps

      - name: Cleanup
        if: always()
        run: |
          echo "Stopping FaultMaven stack..."
          ./faultmaven stop || docker compose down || true
