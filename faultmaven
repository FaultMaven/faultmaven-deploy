#!/bin/bash
# FaultMaven Self-Hosted CLI Wrapper
# Simplifies deployment and management of FaultMaven services

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Configuration
MIN_RAM_GB=8
REQUIRED_COMMANDS=("docker" "docker-compose")

#######################################
# Utility Functions
#######################################

print_header() {
    echo -e "${BLUE}╔════════════════════════════════════════╗${NC}"
    echo -e "${BLUE}║${NC}  FaultMaven Self-Hosted Manager      ${BLUE}║${NC}"
    echo -e "${BLUE}╚════════════════════════════════════════╝${NC}"
    echo ""
}

print_success() {
    echo -e "${GREEN}✓${NC} $1"
}

print_error() {
    echo -e "${RED}✗${NC} $1"
}

print_warning() {
    echo -e "${YELLOW}⚠${NC} $1"
}

print_info() {
    echo -e "${BLUE}ℹ${NC} $1"
}

#######################################
# Pre-flight Checks
#######################################

check_dependencies() {
    print_info "Checking dependencies..."

    local all_present=true

    for cmd in "${REQUIRED_COMMANDS[@]}"; do
        if ! command -v "$cmd" &> /dev/null; then
            print_error "$cmd is not installed"
            all_present=false
        else
            print_success "$cmd found"
        fi
    done

    if [ "$all_present" = false ]; then
        echo ""
        print_error "Missing required dependencies. Please install Docker and Docker Compose."
        echo "Visit: https://docs.docker.com/get-docker/"
        exit 1
    fi
}

check_docker_running() {
    if ! docker info &> /dev/null; then
        print_error "Docker daemon is not running"
        echo "Please start Docker Desktop or the Docker service"
        exit 1
    fi
    print_success "Docker daemon is running"
}

check_resources() {
    print_info "Checking system resources..."

    # Check available RAM (Linux/Mac compatible)
    if [[ "$OSTYPE" == "linux-gnu"* ]]; then
        local total_ram=$(free -g | awk '/^Mem:/{print $2}')
        local available_ram=$(free -g | awk '/^Mem:/{print $7}')
    elif [[ "$OSTYPE" == "darwin"* ]]; then
        # macOS
        local total_ram=$(sysctl -n hw.memsize | awk '{print int($1/1024/1024/1024)}')
        local available_ram=$total_ram  # Simplified for macOS
    else
        print_warning "Cannot determine RAM on this OS, skipping check"
        return
    fi

    if [ "$available_ram" -lt "$MIN_RAM_GB" ]; then
        print_warning "Only ${available_ram}GB RAM available (${MIN_RAM_GB}GB minimum recommended)"
        print_warning "FaultMaven may run slowly or fail to start"
        echo ""
        read -p "Continue anyway? (y/N) " -n 1 -r
        echo ""
        if [[ ! $REPLY =~ ^[Yy]$ ]]; then
            print_info "Startup cancelled"
            exit 1
        fi
    else
        print_success "Sufficient RAM available (${available_ram}GB)"
    fi
}

check_env_file() {
    if [ ! -f .env ]; then
        print_warning ".env file not found"
        print_info "Creating .env from .env.example..."

        if [ -f .env.example ]; then
            cp .env.example .env
            print_success ".env file created"
            echo ""
            print_warning "ACTION REQUIRED: Add your API key to .env file"
            echo ""
            echo "Edit .env and set one of:"
            echo "  OPENAI_API_KEY=sk-..."
            echo "  ANTHROPIC_API_KEY=sk-ant-..."
            echo "  FIREWORKS_API_KEY=fw_..."
            echo ""
            read -p "Press Enter after you've added your API key..."
        else
            print_error ".env.example not found"
            exit 1
        fi
    fi

    # Check if API key is configured
    if grep -q "OPENAI_API_KEY=sk-\.\.\." .env && \
       grep -q "# ANTHROPIC_API_KEY=sk-ant-\.\.\." .env && \
       grep -q "# FIREWORKS_API_KEY=fw_\.\.\." .env; then
        print_warning "API key appears to be placeholder value"
        print_warning "Please set a real API key in .env file"
        echo ""
        read -p "Continue anyway? (y/N) " -n 1 -r
        echo ""
        if [[ ! $REPLY =~ ^[Yy]$ ]]; then
            exit 1
        fi
    else
        print_success ".env file configured"
    fi
}

check_override_file() {
    if [ ! -f docker-compose.override.yml ]; then
        print_warning "docker-compose.override.yml not found (recommended for resource limits)"
        echo ""
        read -p "Create it now? (Y/n) " -n 1 -r
        echo ""
        if [[ ! $REPLY =~ ^[Nn]$ ]]; then
            # Will be created by create_override function
            return 0
        fi
    else
        print_success "Resource limits configured (docker-compose.override.yml)"
    fi
}

create_override_if_missing() {
    if [ ! -f docker-compose.override.yml ]; then
        print_info "Creating docker-compose.override.yml with resource limits..."
        cat > docker-compose.override.yml << 'EOF'
# Docker Compose Override - Resource Limits
# This file prevents FaultMaven from overwhelming your system
# Auto-generated by ./faultmaven script

services:
  fm-knowledge-service:
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 2G
        reservations:
          memory: 1G

  fm-agent-service:
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 1.5G
        reservations:
          memory: 512M

  chromadb:
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 1G
        reservations:
          memory: 512M

  redis:
    deploy:
      resources:
        limits:
          cpus: '0.25'
          memory: 512M
        reservations:
          memory: 256M
EOF
        print_success "Resource limits configured"
    fi
}

#######################################
# Core Commands
#######################################

cmd_start() {
    print_header
    echo "Starting FaultMaven services..."
    echo ""

    check_dependencies
    check_docker_running
    check_resources
    check_env_file
    check_override_file
    create_override_if_missing

    echo ""
    print_info "Starting Docker containers (this may take 5-10 minutes on first run)..."
    echo ""

    if docker compose up -d --build; then
        echo ""
        print_success "FaultMaven services started!"
        echo ""
        echo "Next steps:"
        echo "  1. Check status:  ./faultmaven status"
        echo "  2. View logs:     ./faultmaven logs"
        echo "  3. Access API:    http://localhost:8090"
        echo ""
    else
        echo ""
        print_error "Failed to start services"
        echo "Run './faultmaven logs' to see error details"
        exit 1
    fi
}

cmd_stop() {
    print_header
    echo "Stopping FaultMaven services..."
    echo ""

    if docker compose down; then
        print_success "Services stopped"
        echo ""
        print_info "Data preserved in ./data directory"
        print_info "Run './faultmaven start' to restart"
    else
        print_error "Failed to stop services"
        exit 1
    fi
}

cmd_status() {
    print_header
    echo "Service Status:"
    echo ""

    docker compose ps

    echo ""
    echo "Health Checks:"
    echo ""

    # Health check endpoints
    local services=(
        "8001:Auth Service"
        "8002:Session Service"
        "8003:Case Service"
        "8004:Knowledge Service"
        "8005:Evidence Service"
        "8006:Agent Service"
        "8090:API Gateway"
    )

    for service in "${services[@]}"; do
        local port="${service%%:*}"
        local name="${service#*:}"

        if curl -sf "http://localhost:$port/health" > /dev/null 2>&1; then
            print_success "$name (port $port)"
        else
            print_error "$name (port $port) - Not responding"
        fi
    done

    echo ""

    # Check data directory
    if [ -d ./data ]; then
        local db_size=$(du -sh ./data 2>/dev/null | cut -f1)
        print_info "Data directory size: $db_size"
    fi
}

cmd_logs() {
    print_header

    if [ -z "$1" ]; then
        echo "Streaming logs from all services (Ctrl+C to exit)..."
        echo ""
        docker compose logs -f
    else
        echo "Streaming logs from $1 (Ctrl+C to exit)..."
        echo ""
        docker compose logs -f "$1"
    fi
}

cmd_clean() {
    print_header
    print_warning "This will PERMANENTLY DELETE all data including:"
    echo "  - All cases and troubleshooting sessions"
    echo "  - All uploaded evidence files"
    echo "  - All knowledge base documents"
    echo "  - SQLite database"
    echo ""
    read -p "Are you sure? Type 'DELETE' to confirm: " confirm

    if [ "$confirm" = "DELETE" ]; then
        echo ""
        print_info "Stopping services..."
        docker compose down -v

        if [ -d ./data ]; then
            print_info "Removing data directory..."
            rm -rf ./data
        fi

        print_success "FaultMaven has been reset to factory defaults"
        echo ""
        print_info "Run './faultmaven start' to start fresh"
    else
        print_info "Clean cancelled"
    fi
}

cmd_help() {
    print_header
    echo "Usage: ./faultmaven [command]"
    echo ""
    echo "Commands:"
    echo "  start     Start all FaultMaven services (with pre-flight checks)"
    echo "  stop      Stop all services (preserves data)"
    echo "  status    Show service status and health checks"
    echo "  logs      Stream logs from all services"
    echo "  logs <service>  Stream logs from specific service"
    echo "  clean     DANGER: Delete all data and reset to factory defaults"
    echo "  help      Show this help message"
    echo ""
    echo "Examples:"
    echo "  ./faultmaven start"
    echo "  ./faultmaven logs fm-agent-service"
    echo "  ./faultmaven status"
    echo ""
}

#######################################
# Main
#######################################

case "${1:-}" in
    start)
        cmd_start
        ;;
    stop)
        cmd_stop
        ;;
    status)
        cmd_status
        ;;
    logs)
        cmd_logs "$2"
        ;;
    clean)
        cmd_clean
        ;;
    help|--help|-h|"")
        cmd_help
        ;;
    *)
        print_error "Unknown command: $1"
        echo ""
        cmd_help
        exit 1
        ;;
esac
